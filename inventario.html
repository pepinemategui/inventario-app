<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario M贸vil</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 500px; margin: auto; }
    input, select, button { width: 100%; margin: 0.5em 0; font-size: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    button.delete { background: red; color: white; border: none; padding: 0.3em 0.6em; }
  </style>
</head>
<body>
  <h2> Registro de Inventario</h2>

  <input id="usuario" placeholder="Usuario" />
  <select id="almacen"></select>
  <input id="codigo" placeholder="C贸digo del art铆culo" />
  <input id="descripcion" placeholder="Descripci贸n" disabled />
  <input id="lote" placeholder="Lote" />
  <input id="cantidad" type="number" inputmode="decimal" step="0.01" placeholder="Cantidad" />
  <button id="btnGuardar" onclick="guardar()" disabled>Guardar</button>

  <h3> ltimos 10 registros</h3>
  <table id="tabla">
    <thead><tr><th>C贸digo</th><th>Lote</th><th>Cantidad</th><th>Eliminar</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycby2w6_6wPhzIjZ-4Tohmmr_PkjpGp6EwwQGK1rT4onwfKo4n4ByWyT2e-7Y-mpF9dHp2Q/exec';

    async function cargarAlmacenes() {
      const res = await fetch(`${API_URL}?action=almacenes`);
      const data = await res.json();
      const sel = document.getElementById('almacen');
      sel.innerHTML = '';
      data.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        sel.appendChild(opt);
      });
    }

    // Convierte autom谩ticamente el texto ingresado a MAYSCULAS en los campos usuario, codigo y lote
    document.getElementById('usuario').addEventListener('input', () => {
      const usuarioInput = document.getElementById('usuario');
      usuarioInput.value = usuarioInput.value.toUpperCase();
      validarCampos();
    });

    document.getElementById('codigo').addEventListener('input', () => {
      const codigoInput = document.getElementById('codigo');
      codigoInput.value = codigoInput.value.toUpperCase();
      validarCampos();
    });

    document.getElementById('lote').addEventListener('input', () => {
      const loteInput = document.getElementById('lote');
      loteInput.value = loteInput.value.toUpperCase();
      validarCampos();
    });

    document.getElementById('cantidad').addEventListener('input', validarCampos);

    document.getElementById('descripcion').addEventListener('input', validarCampos);

    document.getElementById('codigo').addEventListener('change', async () => {
      const codigo = document.getElementById('codigo').value;
      const res = await fetch(`${API_URL}?action=descripcion&codigo=${codigo}`);
      const data = await res.json();
      document.getElementById('descripcion').value = data.descripcion || 'No encontrado';
      validarCampos();
    });

    // Verifica que el c贸digo exista en la tabla art铆culos
    async function codigoExiste(codigo) {
      const res = await fetch(`${API_URL}?action=descripcion&codigo=${codigo}`);
      const data = await res.json();
      return !!(data && data.descripcion && data.descripcion !== 'No encontrado');
    }

    async function guardar() {
      const codigo = document.getElementById('codigo').value;

      // Verifica si el c贸digo existe antes de guardar
      if (!(await codigoExiste(codigo))) {
        alert('El c贸digo no existe en la tabla art铆culos.');
        document.getElementById('codigo').focus();
        return;
      }

      const payload = {
        usuario: document.getElementById('usuario').value,
        almacen: document.getElementById('almacen').value,
        codigo: codigo,
        descripcion: document.getElementById('descripcion').value,
        lote: document.getElementById('lote').value,
        cantidad: parseFloat(document.getElementById('cantidad').value),
      };
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      cargarUltimos();

      // Limpiar los campos de c贸digo, lote y cantidad
      document.getElementById('codigo').value = "";
      document.getElementById('lote').value = "";
      document.getElementById('cantidad').value = "";
      document.getElementById('descripcion').value = "";

      // Posicionar el cursor en el campo c贸digo
      document.getElementById('codigo').focus();
      validarCampos();
    }

    async function cargarUltimos() {
      const usuario = document.getElementById('usuario').value;
      if (!usuario) return;
      const res = await fetch(`${API_URL}?action=ultimos&usuario=${usuario}`);
      const data = await res.json();
      const tbody = document.querySelector('#tabla tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.codigo}</td><td>${r.lote}</td><td>${r.cantidad}</td>
          <td><button class="delete" onclick="eliminar(${r.id})">X</button></td>`;
        tbody.appendChild(tr);
      });
    }

    async function eliminar(id) {
      await fetch(`${API_URL}?action=eliminar&id=${id}`);
      cargarUltimos();
    }

    function validarCampos() {
      const usuario = document.getElementById('usuario').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();
      const lote = document.getElementById('lote').value.trim();
      const cantidad = document.getElementById('cantidad').value.trim();

      const boton = document.getElementById('btnGuardar');

      // Deshabilita el bot贸n si alg煤n campo est谩 vac铆o o la descripcion dice "No encontrado"
      if (
        !usuario ||
        !codigo ||
        !descripcion ||
        !lote ||
        !cantidad ||
        descripcion.toLowerCase() === 'C贸digo no encontrado'
      ) {
        boton.disabled = true;
      } else {
        boton.disabled = false;
      }
    }

    // Llama a validar al cargar la p谩gina para asegurar el estado inicial
    window.addEventListener('DOMContentLoaded', validarCampos);

    cargarAlmacenes();
  </script>
</body>
</html>
